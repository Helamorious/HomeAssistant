# Keep the configuration up to date with the latest stable release

# Note; when using travis-ci.com (instead of .org), need to fix the
#  URI thats passed into travispy. This is done at:
#    /usr/src/homeassistant/homeassistant/components/travisci/sensor.py
#  By modifying line 65 to:
#    travis = TravisPy.github_auth(token, uri='https://api.travis-ci.com')

# Connect to TravisCI
sensor:
  - platform: travisci
    api_key: !secret github_access_token
    repository: Helamorious/HomeAssistant

# Create a item to hold the value of the current version
input_text:
  current_build_id:
    initial: "default"

# The Shell Command to update GIT
shell_command:
  git_pull: 'git pull'

automation:
  # When the build ID doesn't match our current build
  trigger:
    - platform: template
      value_template: "{{ state_attr('sensor.helamorious_homeassistant','last_build_id') != state('input_text.current_build_id') }}"
  # If its a successful build
  condition:
    condition: state
    entitiy_id: "sensor.helamorious_homeassistant_last_build_state"
    state: "passed"
  action:
    # Run these actions in order...
    sequence:
      # Update our value
      - service: input_text.set_value
        target:
          entity_id: input_text.current_build_id
        data:
          value: "{{ state_attr('sensor.helamorious_homeassistant', 'last_build_id') }}"
      # Fetch the new config from GIT
      - service: shell_command.git_pull
      # Restart HomeAssistant
      - service: homeassistant.restart